<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Predicci√≥n de Burnout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root{
            --bg:#e8ecf3;
            --card:#e8ecf3;
            --muted:#6c757d;
            --primary:#3a7bd5;
            --text:#243447;
            --soft-shadow: 8px 8px 16px rgba(198,201,208,0.9);
            --light-shadow: -8px -8px 16px rgba(255,255,255,0.95);
        }

        html,body {
            height: 100%;
        }

        body {
            background: radial-gradient(circle at 10% 10%, #f2f5f9 0%, var(--bg) 35%, #e6ebf2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text);
            min-height: 100vh;
            margin: 0;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        nav.navbar {
            background: linear-gradient(145deg, #2e3b4b, #24303d);
            color: #fff;
            box-shadow: var(--soft-shadow), var(--light-shadow);
            border-bottom-left-radius: 18px;
            border-bottom-right-radius: 18px;
        }
        nav .navbar-brand { font-weight:700; letter-spacing:0.2px; }
        nav .btn-outline-light {
            border-radius:10px;
            padding:6px 10px;
            box-shadow: inset 3px 3px 8px rgba(0,0,0,0.06), inset -3px -3px 8px rgba(255,255,255,0.04);
        }

        .card {
            background: var(--card);
            border-radius: 16px !important;
            border: none !important;
            box-shadow: var(--soft-shadow), var(--light-shadow);
        }

        .form-control, .form-select {
            background: var(--card);
            border: none;
            border-radius: 12px;
            padding: 10px 14px;
            box-shadow: inset 6px 6px 12px rgba(198,201,208,0.6), inset -6px -6px 12px rgba(255,255,255,0.9);
            transition: box-shadow .18s ease, transform .12s ease;
        }
        .form-control:focus, .form-select:focus {
            outline: none;
            box-shadow: inset 3px 3px 8px rgba(198,201,208,0.6), inset -3px -3px 8px rgba(255,255,255,0.95);
            transform: translateY(-1px);
        }

        h2, h4, h5 { color: var(--text); font-weight:700; }
        .text-primary { color: var(--primary) !important; }

        .btn-primary {
            background: linear-gradient(180deg, var(--primary), #2f65b8);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            box-shadow: 6px 6px 14px rgba(58,123,213,0.18), -6px -6px 14px rgba(255,255,255,0.4);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 8px 8px 18px rgba(58,123,213,0.22); }

        .btn-group .btn {
            border: none !important;
            background: var(--card);
            color: var(--text);
            border-radius: 10px;
            margin-right: 6px;
            box-shadow: 4px 4px 10px rgba(198,201,208,0.6), -4px -4px 10px rgba(255,255,255,0.9);
            transition: transform .08s ease, box-shadow .12s ease;
            padding: 8px 10px;
        }
        .btn-group .btn:hover { transform: translateY(-2px); }
        .option-btn.active {
            background: linear-gradient(180deg, #2d5fb6, #1f4f9d) !important;
            color: white !important;
            box-shadow: inset 3px 3px 8px rgba(0,0,0,0.25), 6px 6px 14px rgba(0,0,0,0.08);
        }

        .card.result-card {
            position: relative;
            overflow: visible;
        }
        #resultadoClase {
            font-weight: 800;
            font-size: 1.35rem;
            color: #0f1724;
            margin-top: 6px;
        }
        .result-badge {
            display:inline-flex;
            align-items:center;
            gap:10px;
            padding:10px 14px;
            border-radius:999px;
            background: linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.2));
            box-shadow: 4px 4px 12px rgba(198,201,208,0.5), -4px -4px 12px rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.5);
            font-weight:700;
            color: #0b3a66;
        }
        .result-hero {
            margin-top:12px;
            padding:18px;
            border-radius:12px;
            background: linear-gradient(135deg, rgba(58,123,213,0.06), rgba(58,123,213,0.02));
            box-shadow: inset 3px 3px 8px rgba(255,255,255,0.6);
        }

        #resumenShap {
            background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.35));
            border-radius: 12px;
            padding: 16px;
            box-shadow: inset 6px 6px 12px rgba(198,201,208,0.6), inset -6px -6px 12px rgba(255,255,255,0.95);
            color: #16324a;
            font-size: 0.98rem;
            line-height: 1.45;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            color: var(--muted);
            font-size: 0.9rem;
        }

        @media (max-width: 576px) {
            .btn-group .btn { margin-bottom:6px; }
            .card { padding:16px !important; }
            #resultadoClase { font-size: 1.15rem; }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 px-4">
  <span class="navbar-brand fw-bold">üî• Test de burnout</span>
  <div class="ms-auto d-flex align-items-center">
    <span class="text-white me-3">üë§ Usuario {{ username }}</span>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Cerrar sesi√≥n</a>
  </div>
</nav>

<div class="container my-4">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">Predicci√≥n de Burnout</h2>
        <p class="text-secondary">Complete los siguientes campos para generar la predicci√≥n.</p>
    </div>

    <!-- Formulario -->
    <div class="card p-4 mb-4">
        <form id="burnoutForm">
            <h4 class="fw-bold text-primary mb-3">Datos Generales:</h4>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" id="nombre" class="form-control" placeholder="Ingrese nombre completo" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Correo electr√≥nico</label>
                    <input type="email" id="correo" class="form-control" placeholder="Ingrese correo" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Sector Laboral</label>
                    <select id="sector" class="form-select" required>
                        <option selected disabled>Seleccione</option>
                        <option value="salud">Salud</option>
                        <option value="educacion">Educaci√≥n</option>
                        <option value="privado">Privado</option>
                        <option value="servicios">Servicios</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Antig√ºedad laboral</label>
                    <select id="antiguedad" class="form-select" required>
                        <option selected disabled>Seleccione</option>
                        <option value="0-1">Menos de 1 a√±o</option>
                        <option value="1-5">1 a 5 a√±os</option>
                        <option value="6-10">6 a 10 a√±os</option>
                        <option value="10+">M√°s de 10 a√±os</option>
                    </select>
                </div>
            </div>

            <hr class="my-4">

            <!-- PREGUNTAS DEL MBI-GS -->
            <h4 class="fw-bold text-primary mb-1">Preguntas del MBI-GS:</h4>
            <p class="text-secondary mb-3">
                <strong>Escala de frecuencia (0‚Äì6):</strong><br>
                0 = Nunca | 1 = Casi nunca | 2 = Algunas veces al a√±o | 3 = Varias veces al a√±o |
                4 = Algunas veces al mes | 5 = Varias veces a la semana | 6 = Todos los d√≠as
            </p>

            <div class="row" id="itemsInput"></div>
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary px-4 py-2">Predecir</button>
            </div>
        </form>
    </div>

    <!-- Resultado -->
    <div class="card p-4 mb-4 result-card">
        <h5 class="text-dark">Resultado</h5>
>
        <div class="d-flex align-items-center gap-3 result-hero">
            <div class="result-badge">üîç Resultado</div>
            <div>
                <div id="resultadoClase">‚Äî</div>
                <div class="text-muted" style="font-size:0.95rem;">Aqu√≠ ver√°s el nivel predicho y recomendaciones breves.</div>
            </div>
        </div>

    </div>

    <!-- Interpretaci√≥n SHAP -->
    <div class="card p-4 mb-4">
        <h5 class="text-dark">Interpretaci√≥n del modelo (SHAP)</h5>
        <p class="text-secondary">
            A continuaci√≥n se muestra un resumen textual de los factores que m√°s influyeron en la predicci√≥n individual:
        </p>
        <div id="resumenShap" class="mt-2 p-3" style="white-space: pre-wrap; line-height: 1.5;">
            <em class="text-muted">Esperando resultados...</em>
        </div>
    </div>

    <footer>¬© 2025 Burnout WebApp - Todos los derechos reservados</footer>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="confirmModalLabel">Mostrar resultados</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¬øQuieres mostrar estos resultados en el usuario?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button type="button" id="btnConfirmarSi" class="btn btn-primary">S√≠</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="resultadoModal" tabindex="-1" aria-labelledby="resultadoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="resultadoModalLabel">Resultados del Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="resultadoContenido"></div>
    </div>
  </div>
</div>


<div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-3">
      <div class="modal-header border-0">
        <h5 class="modal-title w-100" id="welcomeModalLabel">Bienvenido al Test de Burnout</h5>
      </div>
      <div class="modal-body">
        <p>Selecciona una opci√≥n para continuar</p>
        <button id="btnTest" class="btn btn-primary m-2">Hacer el test</button>
        <button id="btnLogin" class="btn btn-secondary m-2">Iniciar sesi√≥n</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 16 Preguntas 
const preguntas = [
    "1. Me siento emocionalmente agotado por mi trabajo.",
    "2. Al final de la jornada laboral me siento sin energ√≠as.",
    "3. Me cuesta levantarme por la ma√±ana pensando en otro d√≠a de trabajo.",
    "4. Trabajar todo el d√≠a me resulta realmente agotador.",
    "5. Soy capaz de resolver con eficacia los problemas que surgen en mi trabajo.",
    "6. Siento que estoy quemado por mi trabajo.",
    "7. Considero que realizo una contribuci√≥n valiosa en mi organizaci√≥n.",
    "8. Desde que empec√© en este trabajo, he perdido inter√©s en lo que hago.",
    "9. He notado que he perdido el entusiasmo por mi trabajo.",
    "10. Creo que soy muy bueno en lo que hago.",
    "11. Me siento satisfecho cuando logro algo en mi trabajo.",
    "12. He conseguido resultados que considero valiosos en mi labor.",
    "13. Prefiero hacer mi trabajo sin que nadie me moleste.",
    "14. √öltimamente me he vuelto m√°s esc√©ptico respecto al valor de mi trabajo.",
    "15. A veces dudo si lo que hago realmente vale la pena.",
    "16. Estoy seguro de que soy eficaz en lo que hago en mi trabajo."
];

const itemsDiv = document.getElementById("itemsInput");
itemsDiv.innerHTML = "";
preguntas.forEach((texto, index) => {
    const num = index + 1;
    const col = document.createElement("div");
    col.className = "col-12 mb-3";
    col.innerHTML = `
        <label class="form-label fw-semibold">${texto}</label>

        <div class="btn-group w-100 d-flex justify-content-between" data-question="item${num}">
            ${[0,1,2,3,4,5,6].map(v =>
                `<button type="button" class="btn btn-outline-primary flex-fill option-btn" data-value="${v}">${v}</button>`
            ).join("")}
        </div>

        <input type="hidden" id="item${num}" value="">
    `;
    itemsDiv.appendChild(col);
});

document.addEventListener("click", (evt) => {
    if (evt.target && evt.target.classList.contains("option-btn")) {
        const btn = evt.target;
        const grupo = btn.parentElement;
        const hidden = grupo.nextElementSibling;
        grupo.querySelectorAll("button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        hidden.value = btn.dataset.value;
    }
});

function collectResponsesArray() {
    const arr = [];
    for (let i = 1; i <= 16; i++) {
        const val = document.getElementById(`item${i}`).value;
        arr.push(val === "" ? 0 : parseInt(val));
    }
    return arr;
}

function generateAndDownloadPDF(payloadPDF) {
    fetch("/generar_pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payloadPDF)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.pdf_base64) {
            const a = document.createElement("a");
            a.href = "data:application/pdf;base64," + data.pdf_base64;
            a.download = data.filename || "reporte.pdf";
            a.click();
        } else {
            console.error("Error:", data);
        }
    })

}


document.getElementById("burnoutForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = {};
    data["nombre"] = document.getElementById("nombre").value || "Sin nombre";
    data["correo"] = document.getElementById("correo").value || "";
    data["sector"] = document.getElementById("sector").value || "";
    data["antiguedad"] = document.getElementById("antiguedad").value || "";

    for (let i = 1; i <= 16; i++) {
        data[`item${i}`] = parseInt(document.getElementById(`item${i}`).value || 0);
    }

    try {
        const response = await fetch("/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.error) return alert("Error: " + result.error);

        // Mostrar predicci√≥n en la web
        document.getElementById("resultadoClase").innerText =
            "Nivel de burnout predicho: " + result.prediction;


        // ‚úÖ Interpretaci√≥n textual SHAP
        const resumenDiv = document.getElementById("resumenShap");
        if (result.resumen_shap) {
            resumenDiv.innerText = result.resumen_shap;
        } else {
            resumenDiv.innerHTML = "<em class='text-muted'>No se gener√≥ una interpretaci√≥n textual para esta predicci√≥n.</em>";
        }

        const respuestasArray = collectResponsesArray();
        const payloadPdf = {
        nombre: data.nombre,
        correo: data.correo,
        clase: result.prediction,
        resumen_shap: result.resumen_shap 
        };

        await generateAndDownloadPDF(payloadPdf);

    } catch (err) {
        alert("Error en la predicci√≥n: " + (err.message || err));
        console.error(err);
    }
});

document.addEventListener("DOMContentLoaded", function() {
    const modalEl = document.getElementById('welcomeModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    document.getElementById("btnTest").addEventListener("click", function() {
        modal.hide();
    });

    document.getElementById("btnLogin").addEventListener("click", function() {
        window.location.href = "/login";
    });
});
</script>
</body>
</html>
